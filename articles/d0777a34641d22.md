---
title: "Reactã§ã®èªè¨¼æ™‚ã«JWTã‚’Cookieã«è¨­å®šã™ã‚‹æ–¹æ³•"
emoji: "ğŸª"
type: "tech"
topics: ["react", "authentication", "express"]
published: true
---

SPAã§ã®èªè¨¼ã¨ã„ãˆã°JWTã‚’ä½¿ã†ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ãŒã€
localStorageã«ä¿å­˜ã™ã‚‹ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒé«˜ã„ã¨ã‹ã§ã€
Cookieã«HttpOnlyãªå€¤ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã®ãŒè‰¯ã„ã¨ã—ã°ã—ã°è¨€ã‚ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
ä»Šå›ã¯React Ã— Expressã§JWTã‚’Cookieã«ä¿å­˜ã™ã‚‹å…·ä½“çš„ãªæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ï¼ˆãã‚‚ãã‚‚JWTã‚’ä½¿ã†ã¹ãã‹ã¨ã‹ã€localStorageã‚’ä½¿ã†ã“ã¨ã®ãƒªã‚¹ã‚¯ãªã©ã«ã¤ã„ã¦ã¯è¦ä»¶æ¬¡ç¬¬ãªã®ã§ã‚ã¾ã‚Šè¨€åŠã—ã¾ã›ã‚“ï¼‰

èª¿æŸ»ã«ã‚ãŸã£ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚
[React Authentication: How to Store JWT in a Cookie](https://medium.com/@ryanchenkie_40935/react-authentication-how-to-store-jwt-in-a-cookie-346519310e81)

è¨˜äº‹ã®æ–¹æ³•ãã®ã¾ã¾ã§ã¯è‡ªåˆ†ã®ç’°å¢ƒã§ã¯ä¸Šæ‰‹ãã„ã‹ãªã‹ã£ãŸã®ã§ã€ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆã‚‚å«ã‚ã¦æ‰‹é †ã‚’è§£èª¬ã—ã¾ã™ã€‚

# æœ€çµ‚çš„ã«å‡ºæ¥ä¸ŠãŒã£ãŸã‚‚ã®

- **JWTã‚’Cookieã«ä¿å­˜ã™ã‚‹**
https://github.com/Kanatani28/jwt-how-to-use/tree/fix_using_cookies

- **CSRFå¯¾ç­–**
https://github.com/Kanatani28/jwt-how-to-use/tree/fix_using_csrf_protection

# å‹•ä½œç’°å¢ƒ
ä»¥ä¸‹ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦æŒ™å‹•ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚
[node:15.5.1-alpine3.12](https://hub.docker.com/_/node)


# æº–å‚™ç·¨

ã¾ãšã¯localStorageã«JWTã‚’ä¿å­˜ã—ã¦å‹•ãã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”¨æ„ã—ã¾ã™ã€‚
ä¸Šè¨˜ã®å‚è€ƒè¨˜äº‹ã‚’è¦‹ã¦ã‚‚ã‚‰ã£ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€
ã“ã¡ã‚‰ã§ç”¨æ„ã—ãŸä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’è¦‹ã¦ã‚‚ã‚‰ã£ã¦ã‚‚è‰¯ã„ã§ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ã“ã¡ã‚‰ã«æº–ã˜ã¦é€²ã‚ã¾ã™ã€‚

Reactã®éƒ¨åˆ†ã ã‘TypeScriptã‚’ä½¿ç”¨ + Dockerã‚’ä½¿ã£ãŸæ§‹æˆ
https://github.com/Kanatani28/jwt-how-to-use

ï¼ˆã¡ãªã¿ã«è‡ªå‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãŸã„å ´åˆã¯`create-react-app`ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã€å„ç¨®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚ï¼‰

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```tsx:App.tsx
import React, { useState } from 'react';
import axios from 'axios';
import './App.css';

const apiUrl = 'http://localhost:3001';

axios.interceptors.request.use(
  // allowedOriginã¨é€šä¿¡ã™ã‚‹ã¨ãã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹è¨­å®š
  config => {
    const { origin } = new URL(config.url as string);
    const allowedOrigins = [apiUrl];
    const token = localStorage.getItem('token');
    if (allowedOrigins.includes(origin)) {
      config.headers.authorization = `Bearer ${token}`;
    }
    return config;
  },
  error => {
    return Promise.reject(error);
  }
);

type Food = {
  id: number
  description: string
}

function App() {
  const storedJwt = localStorage.getItem('token');
  const [jwt, setJwt] = useState(storedJwt || null);
  const [foods, setFoods] = useState<Food[]>([]);
  const [fetchError, setFetchError] = useState(null);
  
  const getJwt = async () => {
    const { data } = await axios.get(`${apiUrl}/jwt`);
    localStorage.setItem('token', data.token);
    setJwt(data.token);
  };

  const getFoods = async () => {
    try {
      const { data } = await axios.get(`${apiUrl}/foods`);
      setFoods(data);
      setFetchError(null);
    } catch (err) {
      setFetchError(err.message);
    }
  };
  
  return (
    <>
      <section style={{ marginBottom: '10px' }}>
        <button onClick={() => getJwt()}>Get JWT</button>
        {jwt && (
          <pre>
            <code>{jwt}</code>
          </pre>
        )}
      </section>
      <section>
        <button onClick={() => getFoods()}>
          Get Foods
        </button>
        <ul>
          {foods.map((food, i) => (
            <li>{food.description}</li>
          ))}
        </ul>
        {fetchError && (
          <p style={{ color: 'red' }}>{fetchError}</p>
        )}
      </section>
    </>
  );
}
export default App;
```

```js:server.js
const express = require('express');
const jwt = require('express-jwt');
const jsonwebtoken = require('jsonwebtoken');
const cors = require('cors');

const app = express();

app.use(cors());

const jwtSecret = 'secret123';

app.get('/jwt', (req, res) => {
  // JWTã‚’ç”Ÿæˆã™ã‚‹ï¼ˆä»Šå›ã¯å›ºå®šå€¤ã§ä½œæˆã—ã¦ã„ã‚‹ï¼‰
  res.json({
    token: jsonwebtoken.sign({ user: 'johndoe' }, jwtSecret)
  });
});

app.use(jwt({ secret: jwtSecret, algorithms: ['HS256'] }));

const foods = [
  { id: 1, description: 'burritos' },
  { id: 2, description: 'quesadillas' },
  { id: 3, description: 'churos' }
];

app.get('/foods', (req, res) => {
  res.json(foods);
});

app.listen(3001);
console.log('App running on localhost:3001');
```

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦
server.jsã«ã¯`/jwt`ã¨`/foods`ã¨ã„ã†ï¼’ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚
`/jwt`ã¯JWTã‚’ã€`/foods`ã¯JSONãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã™ã€‚
App.tsxã§ã¯ãƒœã‚¿ãƒ³ã‚’ï¼’ã¤ç”¨æ„ã—ã€ãã‚Œãã‚Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

`docker-compose up`ã‚’å®Ÿè¡Œã™ã‚‹ã¨`localhost:3000`ã§Reactã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç«‹ã¡ä¸ŠãŒã‚Šã€
ãã®å¾Œ`docker-compose exec front node src/server.js`ã‚’å®Ÿè¡Œã™ã‚‹ã¨
`localhost:3001`ã§Node.jsã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚

`localhost:3000`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

ã„ããªã‚ŠGet Foodsãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨401ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã€
Get JWTã§JWTã‚’å–å¾—å¾Œã€Get Foodsãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ä»Šåº¦ã¯æ­£å¸¸ã«é€šä¿¡ã§ãã‚‹ã¯ãšã§ã™ã€‚

- **JWTãªã—ã§é€šä¿¡**
![](https://storage.googleapis.com/zenn-user-upload/jl8gpfoa5kavscm6vfqxphqw2hzo)


- **JWTã‚ã‚Šã§é€šä¿¡**
![](https://storage.googleapis.com/zenn-user-upload/09ckrs3bzuvf26gw2dr5iyvr42ne)

## localStorageã‚’ç¢ºèªã—ã¦ã¿ã‚‹
Chromeã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ« > Applicationã‚’é–‹ãã¨localStorageã«å–å¾—ã—ãŸtokenãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/kpvc7ju10jclccbjlt8yd3jedddy)

localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€å½“ç„¶JavaScriptã§å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```js
localStorage.getItem("token")
```

ã“ã®çŠ¶æ…‹ãŒã‚ã¾ã‚Šã‚ˆã‚ã—ããªã„ã®ã§ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚

# ä¿®æ­£ç·¨

## JWTã‚’Cookieã«ä¿å­˜ã™ã‚‹

ã¾ãšæœ€åˆã«server.jsã®JWTã‚’ç™ºè¡Œã™ã‚‹éƒ¨åˆ†ã‚’ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚

### ãã‚‚ãã‚‚Cookieã®ä»•çµ„ã¿ã£ã¦ï¼Ÿ

å›³ã«ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ï¼ˆçŸ¥ã£ã¦ã‚‹ã‚ˆã£ã¦äººã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/xe8zutv7tpb1kwhypqc36gedykiz)

ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«Set-Cookieã¨ã„ã†å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ãŸå ´åˆã€
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®Cookieã«ãã®å€¤ãŒã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
ä»¥é™ãã®ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã§ã¯ã‚»ãƒƒãƒˆã•ã‚ŒãŸCookieã®å€¤ãŒä»˜ä¸ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã ã¨ã“ã†ã„ã£ãŸä»•çµ„ã¿ã‚’æä¾›ã—ã¦ã„ã‚‹ã‚‚ã®ãŒå¤šã„ã§ã™ã€‚

### Set-Cookieãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹

Cookieã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«Set-Cookieãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
Cookieã‚’ä½¿ã†ãŸã‚ã€JWTå–å¾—æ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ã«Set-Cookieãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å«ã‚ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```js:server.js
app.get('/jwt', (req, res) => {
  const token = jsonwebtoken.sign({ user: 'johndoe' }, jwtSecret);
  // Set-Cookieãƒ˜ãƒƒãƒ€ãƒ¼ã«tokenã‚’ã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†
  res.cookie('token', token, { httpOnly: true });
  res.json({ token });
});
```

ä»Šå›ã¯HttpOnlyã‚’trueã¨ã—ã¦ã„ã‚‹ãŸã‚ã€`document.cookie`ã®ã‚ˆã†ãªJavaScriptã‹ã‚‰ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããšã€
åŸºæœ¬çš„ã«ã¯HTTPé€šä¿¡ã™ã‚‹ã¨ãã®ã¿å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ï¼ˆHttpOnlyã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã¯localStorageã«ä¿å­˜ã™ã‚‹æ–¹æ³•ã¨å¤§å·®ãªã„ã‹ã¨æ€ã„ã¾ã™ï¼‰

### CORSå¯¾å¿œã™ã‚‹ï¼ˆãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆï¼‰

ã“ã¡ã‚‰ã¯å…ƒè¨˜äº‹ã«ã¯ãªã‹ã£ãŸæ‰‹é †ã«ãªã‚Šã¾ã™ã€‚
SPAã§ã¯ã‚ˆãã‚ã‚‹æ§‹æˆã‹ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã¯`localhost:3000`ã¨`localhost:3001`ã¨
ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚
ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã§Cookieã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ã„ãã¤ã‹è¨­å®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

server.jsã®corsã‚’è¨­å®šã—ã¦ã„ã‚‹éƒ¨åˆ†ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```js:server.js
app.use(cors({
  credentials: true,
  origin: "http://localhost:3000"
}));
```

ã“ã‚Œã§`localhost:3000`ã§èµ·å‹•ã—ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚‚Cookieã‚’ã‚„ã‚Šå–ã‚Šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€App.tsxã®æ–¹ã«ã‚‚ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```tsx:App.tsx
axios.defaults.withCredentials = true;
```

ä»Šå›ã¯ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«axiosã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€
axiosã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯Cookieã‚’ä½¿ã†è¨­å®šã«ãªã£ã¦ã„ãªã„ã®ã§ã€
ä¸Šè¨˜ã®ã‚ˆã†ã«withCredentialsã‚’trueã«ã™ã‚‹ã“ã¨ã§é€šä¿¡æ™‚ã«Cookieã‚’é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã“ã¾ã§è¨­å®šã§ããŸã‚‰å†åº¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
Get JWTãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨JWTãŒå–å¾—ã§ãã€é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªã™ã‚‹ã¨
Cookieã«tokenãŒè¨­å®šã§ãã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/my8l9jbnvrovgky1q02hxayhfipj)

### Cookieã«è¨­å®šã•ã‚ŒãŸtokenã‚’æ¤œè¨¼ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
server.jsã§App.tsxã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«Cookieã«è¨­å®šã•ã‚ŒãŸtokenã‚’æ¤œè¨¼ã™ã‚‹å‡¦ç†ã‚’è¿½è¨˜ãƒ»ä¿®æ­£ã—ã¾ã™ã€‚

ã¾ãšã¯æ–°ã—ã`cookie-parser`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
docker-compose exec front yarn add cookie-parser
```

æ¬¡ã«server.jsã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```js:server.js
const cookieParser = require('cookie-parser');
// ç•¥
app.use(cookieParser());
app.use(jwt({
  secret: jwtSecret,
  algorithms: ['HS256'],
  getToken: req => req.cookies.token 
}));
```

expressã§ã¯cookie-parserã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§Requestã«å«ã¾ã‚Œã‚‹Cookieã‚’ç°¡å˜ã«å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚(`req.cookies.token`ã®éƒ¨åˆ†)
ã¾ãŸã€æ¤œè¨¼ã‚‚express-jwtã‚’ä½¿ã†ã“ã¨ã§æ‰‹è»½ã«ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
getTokenã§è¨­å®šã—ãŸé–¢æ•°ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€secretã«è¨­å®šã—ãŸå€¤ã‚’ä½¿ã£ã¦æ¤œè¨¼ã™ã‚‹ã¨ã„ã£ãŸã‚ˆã†ãªå½¢ã§ã™ã€‚

æ¬¡ã«App.tsxã®æ–¹ã§ä¸è¦ã«ãªã£ãŸlocalStorageã‚’ä½¿ç”¨ã™ã‚‹éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã¦ãŠãã¾ã™ã€‚
ã“ã®éƒ¨åˆ†ã¯å‚è€ƒè¨˜äº‹ã§ã¯ã“ã®å¯¾å¿œã¯ã—ã¦ã„ã¾ã›ã‚“ãŒã€
localStorageã¨Cookieã©ã¡ã‚‰ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹ã‚ã‹ã‚Šã«ãããªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§å¿µã®ãŸã‚ã«æ¶ˆã—ã¦ãŠãã¾ã™ã€‚

ã¾ãŸã€ã“ã®ä¿®æ­£ã§localStorageã‹ã‚‰JWTã‚’èª­ã¿è¾¼ã¾ãªã„ã‚ˆã†ã«ã—ãŸã®ã§
ç”»é¢è¡¨ç¤ºæ™‚ã«JWTãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒãªããªã‚Šã¾ã™ã€‚
HttpOnlyãªCookieã‚’ä½¿ã£ãŸã®ã§`document.cookie`ã®ã‚ˆã†ãªJavaScriptã‹ã‚‰ã¯å–å¾—ã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```tsx:App.tsx
// ç•¥
// Bearerã§é€ã‚‹å¿…è¦ãŒãªããªã£ãŸã®ã§ä¸è¦
// axios.interceptors.request.use(
//   config => {
//     const { origin } = new URL(config.url as string);
//     const allowedOrigins = [apiUrl];
//     const token = localStorage.getItem('token');
//     if (allowedOrigins.includes(origin)) {
//       config.headers.authorization = `Bearer ${token}`;
//     }
//     return config;
//   },
//   error => {
//     return Promise.reject(error);
//   }
// );

// ç•¥

function App() {
  // localStorageã«ã‚»ãƒƒãƒˆã—ãªããªã£ãŸã®ã§ä¸è¦
  // const storedJwt = localStorage.getItem('token');
  // åˆæœŸå€¤ã¯nullã«ã—ã¦ã„ã‚‹
  const [jwt, setJwt] = useState<string | null>(null);
  // ç•¥
  const getJwt = async () => {
    const { data } = await axios.get(`${apiUrl}/jwt`);
    // localStorageã«ã‚»ãƒƒãƒˆã™ã‚‹å¿…è¦ãŒãªã„ã®ã§ä¸è¦
    // localStorage.setItem('token', data.token);
    setJwt(data.token);
  };
// ç•¥
```

ä»¥ä¸Šã§JWTã‚’Cookieã«ä¿å­˜ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã¨ã‚„ã‚Šã¨ã‚Šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## CSRFå¯¾ç­–

localStorageã¯XSSã«ã‚ˆã‚‹æ”»æ’ƒã‚’å—ã‘ã‚„ã™ã„ã®ã«å¯¾ã—ã¦ã€
Cookieã®å ´åˆã¯CSRFã«ã‚ˆã‚‹æ”»æ’ƒã‚’å—ã‘ã‚„ã™ã„ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚

ãªã®ã§Cookieã‚’ä½¿ã£ãŸtokenã®ã‚„ã‚Šå–ã‚Šã«ã¯CSRFã¸ã®å¯¾ç­–ã¨ã‚»ãƒƒãƒˆã§è¡Œãªã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

server.jsã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js:server.js
app.post('/foods', (req, res) => {
  foods.push({
    id: foods.length + 1,
    description: 'new food'
  });
  res.json({
    message: 'Food created!'
  });
});
```

å®Ÿè£…ã¯é©å½“ã§ã™ãŒã€æ–°ã—ãFoodã‚’è¿½åŠ ã™ã‚‹ã‚ˆã†ãªAPIãŒã§ããŸã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã­ã€‚
æˆåŠŸã—ãŸå ´åˆã¯Food created!ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦ãã¾ã™ã€‚

ã¾ãŸã€App.tsxã®æ–¹ã‹ã‚‰ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```tsx:App.tsx
function App() {
  // ç•¥
  const [newFoodMessage, setNewFoodMessage] = useState(null);
  const createFood = async () => {
    try {
      const { data } = await axios.post(`${apiUrl}/foods`);
      setNewFoodMessage(data.message);
      setFetchError(null);
    } catch (err) {
      setFetchError(err.message);
    }
  };

  // ç•¥
  return (
    <>
      // ç•¥
      <section>
        <button onClick={() => createFood()}>
          Create New Food
        </button>
        {newFoodMessage && <p>{newFoodMessage}</p>}
      </section>
    </>
  );
}
```

### CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹
expressã§ã¯csurfã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã“ã¨ã§
æ‰‹è»½ã«CSRFå¯¾ç­–ã‚’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãšã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
docker-compose exec front yarn add csurf
```

`/csrf-token`ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚

```js:server.js
const csrf = require('csurf')
// ç•¥
const csrfProtection = csrf({
  cookie: true
});
app.use(csrfProtection);
app.get('/csrf-token', (req, res) => {
  res.json({ csrfToken: req.csrfToken() });
});
```

ã“ã‚Œã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€
App.tsxã‹ã‚‰åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:App.tsx
function App() {
  // ç•¥
  useEffect(() => {
    const getCsrfToken = async () => {
      const { data } = await axios.get(`${apiUrl}/csrf-token`);
      axios.defaults.headers.post['X-CSRF-Token'] = data.csrfToken;
    };
    getCsrfToken();
  }, []);
  // ç•¥
}
```

ç”»é¢è¡¨ç¤ºæ™‚ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€axiosã«è¨­å®šã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã§CSRFã®å¯¾ç­–ãŒã§ãã¾ã—ãŸã€‚

â€»ã¡ãªã¿ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æ™‚ã«ã‚‚Cookieã®å€¤ãŒæ¤œè¨¼ã•ã‚Œã‚‹ã®ã§ã€403ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯JWTå–å¾—å¾Œã«ç”»é¢ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰Createã—ã¦ã¿ã¦ãã ã•ã„ã€‚ä»Šå›ã¯ä¸€ç”»é¢ã«ã™ã¹ã¦è©°ã‚è¾¼ã‚“ã§ã„ã‚‹ã®ã§ã“ã‚“ãªæ„Ÿã˜ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/6by76y28eu3zl8t4e9un00seycf5)


# æœ€å¾Œã«
Cookieã®ä»•çµ„ã¿ã‚„CORSã«ã¤ã„ã¦ã®ç†è§£ãŒã‚ã‚Œã°ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒReactã‹ã‚‰Vueã«ãªã‚ã†ãŒ
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒExpressã‹ã‚‰ä»–ã®FWã«ãªã‚ã†ãŒçŸ¥è­˜ã‚’æµç”¨ã§ãã‚‹ã¯ãšã§ã™ã€‚

**ã¾ãŸã€localStorageã§ã‚‚Cookieã§ã‚‚XSSå¯¾ç­–ãŒã•ã‚Œã¦ã„ãªã„å ´åˆã€é›£æ˜“åº¦ã«å·®ã¯ã‚ã‚Œã©ç›—é›£ã®ãƒªã‚¹ã‚¯ãŒç™ºç”Ÿã™ã‚‹ã®ã¯åŒã˜ãªã®ã§
ãã‚‚ãã‚‚XSSå¯¾ç­–ãŒã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯ã¯å¿…é ˆã¨ã„ãˆã‚‹ã§ã—ã‚‡ã†ã€‚**

[ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°(XSS)å¯¾ç­–ã¨ã—ã¦Cookieã®HttpOnlyå±æ€§ã§ã©ã“ã¾ã§å®‰å…¨ã«ãªã‚‹ã®ã‹](https://www.youtube.com/watch?v=4JREwhSC2dQ&feature=youtu.be)

é«˜ã„ä¿å®ˆæ€§ã‚„UXã‚’ä¿æŒã—ã¤ã¤å®‰å…¨ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç›®æŒ‡ã—ã¦ã„ããŸã„ã§ã™ã­ã€‚

# å‚è€ƒ
[React Authentication: How to Store JWT in a Cookie](https://medium.com/@ryanchenkie_40935/react-authentication-how-to-store-jwt-in-a-cookie-346519310e81)
[ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã§CookieãŒè¨­å®šã§ããªã„å ´åˆã«ç¢ºèªã™ã‚‹ã“ã¨](https://qiita.com/y_tochukaso/items/78972e0e2917bb11fa10)
[CORSã¾ã¨ã‚](https://qiita.com/tomoyukilabs/items/81698edd5812ff6acb34#cookie%E3%82%82%E8%A8%B1%E5%8F%AF%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88)
[express.jsã®corså¯¾å¿œ](https://qiita.com/chenglin/items/5e563e50d1c32dadf4c3#cors%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E8%A8%AD%E5%AE%9A)
[Express cors middleware](https://expressjs.com/en/resources/middleware/cors.html)
[MDN Web Docs Set-Cookie](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Set-Cookie)
[ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°(XSS)å¯¾ç­–ã¨ã—ã¦Cookieã®HttpOnlyå±æ€§ã§ã©ã“ã¾ã§å®‰å…¨ã«ãªã‚‹ã®ã‹](https://www.youtube.com/watch?v=4JREwhSC2dQ&feature=youtu.be)
